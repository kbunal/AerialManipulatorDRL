from stable_baselines.common.policies import MlpPolicy
from stable_baselines.common.vec_env import DummyVecEnv
from stable_baselines import  PPO2
import gym
import AerialManipulatorDRL
import numpy as np
import matplotlib.pyplot as plt
import os
from AerialManipulatorDRL.ConvController.Controller import PDpolicy_Arm_Trac_1_DOF
import time




trajck_x = np.array([0.700000000000000,0.699998820505411,0.699990616103924,0.699968505055400,0.699925761801610,0.699855816966245,0.699752257354909,0.699608825955122,0.699419421936318,0.699178100649847,0.698879073628976,0.698516708588885,0.698085529426669,0.697580216221341,0.696995605233826,0.696326688906967,0.695568615865520,0.694716690916158,0.693766375047469,0.692713285429955,0.691553195416035,0.690282034540042,0.688895888518224,0.687390999248746,0.685763764811687,0.684010739469042,0.682128633664719,0.680114314024544,0.677964803356258,0.675677280649516,0.673249081075889,0.670677695988862,0.667960772923838,0.665096115598133,0.662081683910978,0.658915593943522,0.655596117958826,0.652121684401869,0.648490877899542,0.644702439260655,0.640755265475931,0.636648409718008,0.632381081341441,0.627952645882700,0.623362625060168,0.618610696774145,0.613696695106847,0.608620610322404,0.603382588866863,0.597982933368182,0.592422102636240,0.586700711662827,0.580819531621650,0.574779489868331,0.568581669940407,0.562227311557331,0.555717810620471,0.549054719213110,0.542239745600446,0.535274754229593,0.528161765729579,0.520902956911349,0.513500660767763,0.505957366473594,0.498275719385533,0.490458521042186,0.482508729164071,0.474429457653627,0.466223976595202,0.457895712255065,0.449448247081395,0.440885319704291,0.432210824935764,0.423428813769742,0.414543493382067,0.405559227130496,0.396480534554705,0.387312091376280,0.378058729498726,0.368725437007461,0.359317358169819,0.349839793435052,0.340298199434322,0.330698188980710,0.321045531069212,0.311346150876737,0.301606129762113,0.291831705266080,0.282029271111294,0.272205377202327,0.262366729625666,0.252520190649714,0.242672778724787,0.232831668483119,0.223004190738857,0.213197832488065,0.203420236908722,0.193679203360720,0.183982687385870,0.174338800707895,0.164755811232435,0.155242143047046,0.145806376421196,0.136457247806273,0.127203649835576,0.118054631324321,0.109019397269640,0.100107308850579,0.0913278834280991,0.0826907945450788,0.0742058719263095,0.0658831014784990,0.0577326252902701,0.0497647416321609,0.0419899049566248,0.0344187258980302,0.0270619712726616,0.0199305640787175,0.0130355834963132,0.00638826488747779,-2.03843608659327e-10,-2.03843608659327e-10,-0.00612229210674053,-0.0119899824196081,-0.0176186531296034,-0.0230234571769898,-0.0282191145608968,-0.0332199123392742,-0.0380397046289769,-0.0426919126056839,-0.0471895245039304,-0.0515450956171391,-0.0557707482975793,-0.0598781719563659,-0.0638786230634736,-0.0677829251477373,-0.0716014687968656,-0.0753442116574119,-0.0790206784347696,-0.0826399608932409,-0.0862107178559324,-0.0897411752048285,-0.0932391258807837,-0.0967119298834804,-0.100166514271523,-0.103609373162279,-0.107046567732042,-0.110483726215968,-0.113926043908030,-0.117378283161068,-0.120844773386805,-0.124329411055802,-0.127835659697501,-0.131366549900163,-0.134924679310926,-0.138512212635803,-0.142130881639627,-0.145781985146137,-0.149466389037906,-0.153184526256345,-0.156936396801768,-0.160721567733294,-0.164539173168947,-0.168387914285560,-0.172266059318888,-0.176171443563497,-0.180101469372842,-0.184053106159165,-0.188022890393663,-0.192006925606336,-0.196000882386054,-0.199999998380523])
trajck_y = np.array([0.700000000000000,0.699998431616523,0.699987531136614,0.699958181526020,0.699901500363776,0.699808839842206,0.699671786766921,0.699482162556818,0.699232023244082,0.698913659474188,0.698519596505895,0.698042594211253,0.697475647075597,0.696811984197550,0.696045069289024,0.695168600675217,0.694176511294616,0.693062968698993,0.691822375053411,0.690449367136218,0.688938816339051,0.687285828666834,0.685485744737778,0.683534139783382,0.681426823648434,0.679159840791006,0.676729470282462,0.674132225807451,0.671364855663909,0.668424342763061,0.665307904629420,0.662012993400784,0.658537295828241,0.654878733276167,0.651035461722222,0.647005871757358,0.642788588585811,0.638382472025107,0.633786616506059,0.629000351072766,0.624023239382616,0.618855079706285,0.613495904927736,0.607945982544218,0.602205814666271,0.596276138017719,0.590157923935676,0.583852378370542,0.577360941886007,0.570685289659045,0.563827331479919,0.556789211752182,0.549573309492672,0.542182238331515,0.534618846512123,0.526886216891200,0.518987666938733,0.510926748737999,0.502707248985562,0.494333188991274,0.485808824678272,0.477138646582985,0.468327379855127,0.459379984257698,0.450301654166989,0.441097818572576,0.431774141077325,0.422336519897386,0.412791087862199,0.403144212414493,0.393402495610281,0.383572774118866,0.373662119222837,0.363677836818073,0.353627467413738,0.343518786132285,0.333359802709453,0.323158761494272,0.312924141449055,0.302664656149406,0.292389253784215,0.282107117155660,0.271827663679207,0.261560545383609,0.251315648910906,0.241103095516427,0.230933241068788,0.220816676049891,0.210764225554929,0.200786949292379,0.190896141584007,0.181103331364867,0.171420282183301,0.161858992200937,0.152431694192691,0.143150855546768,0.134029178264658,0.125079598961142,0.116315288864285,0.107749653815441,0.0993963342692534,0.0912692052936501,0.0833823765698483,0.0757501923923531,0.0683872316689556,0.0613083079207355,0.0545284692820602,0.0480629985005849,0.0419274129372507,0.0361374645662886,0.0307091399752151,0.0256586603648359,0.0210024815492429,0.0167572939558172,0.0129400226252248,0.00956782721142213,0.00665810198165207,0.00422847581644437,0.00229681220961764,0.000881209268276839,-2.87184054315048e-10,-2.87184054315048e-10,-0.000334488362490948,-0.000134632842110349,0.000581254045101787,0.00179516759430465,0.00348941180650009,0.00564659938855572,0.00824965175313830,0.0112817990188079,0.0147265800099299,0.0185678422567346,0.0227897419952661,0.0273767441674502,0.0323136224210305,0.0375854591096205,0.0431776452926238,0.0490758807353391,0.0552661739088896,0.0617348419902450,0.0684685108622034,0.0754541151134260,0.0826788980383961,0.0901304116374719,0.0977965166168078,0.105665382388457,0.113725487070276,0.121965617485967,0.130374869165088,0.138942646343041,0.147658661961065,0.156512937666236,0.165495803811487,0.174597899455577,0.183810172363128,0.193123879004593,0.202530584556285,0.212022162900309,0.221590796624681,0.231228977023218,0.240929504095574,0.250685486547290,0.260490341789703,0.270337795940055,0.280221883821332,0.290136948962418,0.300077643598087,0.310038928668901,0.320016073821233,0.330004657407390,0.340000566485443,0.349999996819360])
track_beta = np.array([-0.100000000000000,-0.0999999981674305,-0.0999999815721968,-0.0999999250917053,-0.0999997923016208,-0.0999995354758670,-0.0999990955866260,-0.0999984023043390,-0.0999973739977054,-0.0999959177336834,-0.0999939292774901,-0.0999912930926009,-0.0999878823407501,-0.0999835588819306,-0.0999781732743940,-0.0999715647746505,-0.0999635613374689,-0.0999539796158768,-0.0999426249611604,-0.0999292914228647,-0.0999137617487930,-0.0998958073850075,-0.0998751884758293,-0.0998516538638377,-0.0998249410898709,-0.0997947763930258,-0.0997608747106579,-0.0997229396783813,-0.0996806636300689,-0.0996337275978521,-0.0995818013121211,-0.0995245432015247,-0.0994616003929703,-0.0993926087116241,-0.0993171926809110,-0.0992349655225142,-0.0991455291563761,-0.0990484742006972,-0.0989433799719372,-0.0988298144848140,-0.0987073344523045,-0.0985754852856440,-0.0984338010943267,-0.0982818046861053,-0.0981190075669913,-0.0979449099412546,-0.0977590007114240,-0.0975607574782870,-0.0973496465408895,-0.0971251228965364,-0.0968866302407909,-0.0966336009674752,-0.0963654561686699,-0.0960816056347144,-0.0957814478542067,-0.0954643700140035,-0.0951297479992202,-0.0947769463932308,-0.0944053184776679,-0.0940142062324229,-0.0936029403356458,-0.0931708401637453,-0.0927172137913887,-0.0922413579915019,-0.0917425582352697,-0.0912200886921352,-0.0906732122298005,-0.0901011804142263,-0.0895032335096318,-0.0888786004784949,-0.0882264989815524,-0.0875461353777993,-0.0868367047244898,-0.0860973907771364,-0.0853273659895104,-0.0845257915136417,-0.0836918171998188,-0.0828245815965891,-0.0819232119507585,-0.0809868242073914,-0.0800145230098112,-0.0790054016995998,-0.0779585423165976,-0.0768730155989040,-0.0757478809828768,-0.0745821866031326,-0.0733749692925465,-0.0721252545822524,-0.0708320567016429,-0.0694943785783691,-0.0681112118383409,-0.0666815368057269,-0.0652043225029541,-0.0636785266507084,-0.0621030956679344,-0.0604769646718351,-0.0587990574778725,-0.0570682865997669,-0.0552835532494976,-0.0534437473373024,-0.0515477474716776,-0.0495944209593785,-0.0475826238054189,-0.0455112007130711,-0.0433789850838663,-0.0411847990175944,-0.0389274533123037,-0.0366057474643013,-0.0342184696681530,-0.0317643968166833,-0.0292422945009752,-0.0266509170103704,-0.0239890073324694,-0.0212552971531312,-0.0184485068564737,-0.0155673455248731,-0.0126105109389645,-0.00957668957764173,-0.00646455661805707,-0.00327277593562159,-1.04004999057494e-10,-1.04004999057494e-10,0.00335249961567019,0.00677311203456821,0.0102480695472336,0.0137641203896983,0.0173085285626584,0.0208690738315260,0.0244340517263426,0.0279922735418774,0.0315330663375502,0.0350462729374614,0.0385222519303694,0.0419518776697538,0.0453265402737495,0.0486381456251719,0.0518791153715092,0.0550423869249288,0.0581214134622829,0.0611101639251110,0.0640031230196065,0.0667952912166570,0.0694821847518092,0.0720598356253337,0.0745247916021228,0.0768741162117781,0.0791053887486015,0.0812167042714957,0.0832066736041295,0.0850744233348042,0.0868195958165110,0.0884423491669022,0.0899433572683357,0.0913238097678253,0.0925854120770744,0.0937303853724512,0.0947614665950365,0.0956819084505494,0.0964954794094073,0.0972064637066943,0.0978196613421716,0.0983403880803131,0.0987744754502256,0.0991282707457462,0.0994086370253182,0.0996229531120978,0.0997791135939377,0.0998855288233749,0.0999511249175846,0.0999853437584335,0.0999981429924830,0.0999999960309737])
track_vx = np.array([0,-0.000353197618794639,-0.00140237834749400,-0.00313192399457123,-0.00552621636849951,-0.00856963727775197,-0.0122465685308018,-0.0165413919361221,-0.0214384893021861,-0.0269222424374670,-0.0329770331504378,-0.0395872432495718,-0.0467372545433421,-0.0544114488402219,-0.0625942079486843,-0.0712699136772024,-0.0804229478342496,-0.0900376922282988,-0.100098528667823,-0.110589838961296,-0.121496004917191,-0.132801408343980,-0.144490431050137,-0.156547454844135,-0.168956861534448,-0.181703032929548,-0.194770350837908,-0.208143197068002,-0.221805953428303,-0.235743001727284,-0.249938723773418,-0.264377501375178,-0.279043716341038,-0.293921750479471,-0.308995985598949,-0.324250803507947,-0.339670586014936,-0.355239714928391,-0.370942572056784,-0.386763539208589,-0.402686998192279,-0.418697330816326,-0.434778918889205,-0.450916144219388,-0.467093388615348,-0.483295033885559,-0.499505461838493,-0.515709054282625,-0.531890193026426,-0.548033259878371,-0.564122636646932,-0.580142705140582,-0.596077847167796,-0.611912444537045,-0.627630879056803,-0.643217532535543,-0.658656786781739,-0.673933023603863,-0.689030624810388,-0.703933972209789,-0.718627447610537,-0.733095432821107,-0.747322309649970,-0.761292459905601,-0.774990265396473,-0.788400107931059,-0.801506369317831,-0.814293431365264,-0.826745675881829,-0.838847484676002,-0.850583239556253,-0.861937322331058,-0.872894114808888,-0.883437998798217,-0.893553356107518,-0.903224568545265,-0.912436017919931,-0.921172086039988,-0.929417154713909,-0.937155605750169,-0.944371820957240,-0.951050182143595,-0.957175071117707,-0.962730869688051,-0.967701959663097,-0.972072722851322,-0.975827541061195,-0.978950796101193,-0.981426869779786,-0.983240143905449,-0.984375000286655,-0.984815820731877,-0.984546987049588,-0.983552881048261,-0.981817884536369,-0.979326379322386,-0.976062747214785,-0.972011370022039,-0.967156629552620,-0.961482907615002,-0.954974586017660,-0.947616046569064,-0.939391671077689,-0.930285841352008,-0.920282939200494,-0.909367346431620,-0.897523444853859,-0.884735616275685,-0.870988242505570,-0.856265705351988,-0.840552386623412,-0.823832668128315,-0.806090931675170,-0.787311559072450,-0.767478932128630,-0.746577432652181,-0.724591442451577,-0.701505343335290,-0.677303517111795,-0.651970345589564,-0.625490210577071,-0.625490210577071,-0.599235932966877,-0.574561894295993,-0.551424796708036,-0.529781346088774,-0.509588248324022,-0.490802209299574,-0.473379934901239,-0.457278131014810,-0.442453503526103,-0.428862758320896,-0.416462601285005,-0.405209738304215,-0.395060875264349,-0.385972718051193,-0.377901972550536,-0.370805344648211,-0.364639540229998,-0.359361265181700,-0.354927225389108,-0.351294126738054,-0.348418675114299,-0.346257576403669,-0.344767536491947,-0.343905261264961,-0.343627456608484,-0.343890828408330,-0.344652082550287,-0.345867924920178,-0.347495061403784,-0.349490197886915,-0.351810040255373,-0.354411294394957,-0.357250666191440,-0.360284861530683,-0.363470586298437,-0.366764546380523,-0.370123447662721,-0.373503996030852,-0.376862897370696,-0.380156857568107,-0.383342582508803,-0.386376778078652,-0.389216150163445,-0.391817404648929,-0.394137247420986,-0.396132384365345,-0.397759521367860,-0.398975364314275,-0.399736619090454,-0.399999991582156])
track_vy = np.array([0,-0.000469537487717724,-0.00186250906503314,-0.00415545340318961,-0.00732490917343050,-0.0113474150469992,-0.0161995096951390,-0.0218577317890933,-0.0282986200001056,-0.0354987129994190,-0.0434345494582771,-0.0520826680479231,-0.0614196074396005,-0.0714219063045526,-0.0820661033140228,-0.0933287371392544,-0.105186346451491,-0.117615469921975,-0.130592646221951,-0.144094414022662,-0.158097311995352,-0.172577878811262,-0.187512653141638,-0.202878173657723,-0.218650979030758,-0.234807607931989,-0.251324599032659,-0.268178491004010,-0.285345822517287,-0.302803132243732,-0.320526958854589,-0.338493841021101,-0.356680317414511,-0.375062926706064,-0.393618207567002,-0.412322698668569,-0.431152938682008,-0.450085466278563,-0.469096820129476,-0.488163538905992,-0.507262161279353,-0.526369225920803,-0.545461271501585,-0.564514836692943,-0.583506460166120,-0.602412680592359,-0.621210036642904,-0.639875066988998,-0.658384310301885,-0.676714305252807,-0.694841590513009,-0.712742704753733,-0.730394186646223,-0.747772574861723,-0.764854408071475,-0.781616224946723,-0.798034564158711,-0.814085964378681,-0.829746964277877,-0.844994102527543,-0.859803917798922,-0.874152948763257,-0.888017734091792,-0.901374812455769,-0.914200722526433,-0.926472002975026,-0.938165192472793,-0.949256829690976,-0.959723453300819,-0.969541601973565,-0.978687814380457,-0.987138629192739,-0.994870585081655,-1.00186022071845,-1.00808407477436,-1.01351868592063,-1.01814059282852,-1.02192633416925,-1.02485244861407,-1.02689547483424,-1.02803195150098,-1.02823841728555,-1.02749141085918,-1.02576747089312,-1.02304313605862,-1.01929494502691,-1.01449943646925,-1.00863314905686,-1.00167262146101,-0.993594392352924,-0.984375000403853,-0.973990984285039,-0.962418882667726,-0.949635234223156,-0.935616577622575,-0.920339451537223,-0.903780394638347,-0.885915945597186,-0.866722643084986,-0.846177025772991,-0.824255632332443,-0.800935001434586,-0.776191671750663,-0.750002181951918,-0.722343070709594,-0.693190876694933,-0.662522138579180,-0.630313395033580,-0.596541184729372,-0.561182046337804,-0.524212518530116,-0.485609139977552,-0.445348449351356,-0.403406985322771,-0.359761286563042,-0.314387891743408,-0.267263339535118,-0.218364168609411,-0.167666917637533,-0.115148125290726,-0.0607843302402342,-0.0607843302402342,-0.00642389077721539,0.0460897713422952,0.0967875276859775,0.145700248838134,0.192858805383084,0.238294067905120,0.282036906988546,0.324118193217679,0.364568797176814,0.403419589450266,0.440701440622345,0.476445221277347,0.510681801999581,0.543442053373365,0.574756845982984,0.604657050412758,0.633173537246986,0.660337177069980,0.686178840466047,0.710729398019485,0.734019720314612,0.756080677935721,0.776943141467132,0.796637981493138,0.815196068598043,0.832648273366189,0.849025466381832,0.864358518229309,0.878678299492911,0.892015680756963,0.904401532605768,0.915866725623612,0.926442130394804,0.936158617503672,0.945047057534488,0.953138321071606,0.960463278699290,0.967052801001866,0.972937758563635,0.978149021968903,0.982717461801993,0.986673948647166,0.990049353088779,0.992874545711121,0.995180397098498,0.996997777835183,0.998357558505532,0.999290609693841,0.999827801984388,1.00000000596150])



params =[74.35293211, 19.01432525, 29.4257353,  33.81312753, 34.38621683,  4.14946097,74.985] 



os.environ["CUDA_VISIBLE_DEVICES"] = "" # not use gpu since performance becomes worse

env = gym.make("quad-withArm_1Dof-v0")


env.set_init_pos = [trajck_x[0],trajck_y[0]]
env.IsRandomDesPosTrain =True
env.set_des_pos = [-0.1,0.1]
"""
env.init_dist_vel = 0
env.init_dist_ang = 0
env.init_dist_avel = 0
"""

t2w = env.thrust_to_weight_ratio
forceMax=env.totalForce

env = DummyVecEnv([lambda: env])

obs = env.reset()

obs_list = [obs]
act_list = [np.array([[0, 0]])]
actPD_list = [np.array([[0, 0]])]
sum_of_rew = 0

counterLenght = 0
timeList=[]

#params = [ 4.45426533,  2.88644787,  3.23454352,  2.57224364, 11.79429913,  2.40245654] # 2397.9 (better in 20 points)
for i in range(600):
    start = time.time()
    actionPD, _states = PDpolicy_Arm_Trac_1_DOF(obs,forceMax,i,trajck_x,trajck_y,track_beta,track_vx,track_vy, params)
    end = time.time()
    #print(end-start)
    duration = end-start
    timeList.append(duration)
    obs, rewards, dones, info = env.step((actionPD).reshape(1,4))
    counterLenght =counterLenght+1
    sum_of_rew += rewards
    obs_list.append(obs)
    actPD_list.append(actionPD)
    if dones:
        obs = env.reset()
        print("RESET")
        break
    env.render()
    #break

print("Reward collected is:", sum_of_rew )
print(" episode lenght", counterLenght)
meanTime = np.mean(timeList)
print("Average Time for one step:", meanTime )
obs_list = np.array(obs_list)
posx = obs_list[:, :, 0]
posy = obs_list[:, :, 1]
velx = obs_list[:, :, 8]
vely = obs_list[:, :, 9]
betaAngle = obs_list[:, :, 15]
time_step = 0.01
l = posx.shape[0]
t = np.arange(0, time_step*l-0.00001, time_step)


print(" ",t.shape, " " , posx.shape, " ",trajck_x.shape )
plt.figure()
plt.plot(posx[0:t.shape[0]-1],posy[0:t.shape[0]-1],label= "observed Position")
plt.plot(trajck_x[0:t.shape[0]-1],trajck_y[0:t.shape[0]-1],label= "desired Position")
plt.title( "Position ",fontsize=14)
plt.xlabel("x position (m)",fontsize=13)
plt.ylabel("y position (m) ",fontsize=13)
plt.legend(loc='upper left',fontsize=14)
plt.grid()

plt.figure()
plt.title( "Velocity x ")
plt.plot(t[0:t.shape[0]-1],velx[0:t.shape[0]-1],label= "observed Velocity")
plt.plot(t[0:t.shape[0]-1],track_vx[0:t.shape[0]-1],label= "desired Velocity")
plt.xlabel("time (s)",fontsize=13)
plt.ylabel("x velocity (m/s) ",fontsize=13)
plt.legend(loc='upper left',fontsize=14)

plt.figure()
plt.title( "Velocity y ")
plt.plot(t[0:t.shape[0]-1],vely[0:t.shape[0]-1],label= "observed Velocity")
plt.plot(t[0:t.shape[0]-1],track_vy[0:t.shape[0]-1],label= "desired Velocity")
plt.xlabel("time (s)")
plt.ylabel("y velocity (m/s) ")
plt.legend(loc='upper left',fontsize=14)


plt.figure()
plt.title( "beta angle ")
plt.plot(t[10:t.shape[0]-1],betaAngle[10:t.shape[0]-1],label= "observed ")
plt.plot(t[10:t.shape[0]-1],track_beta[10:t.shape[0]-1],label= "desired ")
plt.xlabel("time (s)",fontsize=13)
plt.ylabel("Joint Angle (rad) ",fontsize=13)
plt.legend(loc='upper left',fontsize=14)

#plt.figure()
#plt.plot(t,betaAngle)
plt.figure()

plt.grid()
plt.scatter(trajck_x,trajck_y)
plt.title("Random Starting Points")
plt.xlabel("x position (m)")
plt.ylabel("y position (m) ")

plt.show()

